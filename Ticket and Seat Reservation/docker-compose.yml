services:
  user-service:
    build:
      context: .
      dockerfile: ./user-service/Dockerfile
    dns:
      - 8.8.8.8
      - 8.8.4.4
    ports:
      - "3000:3000"
    environment:
      DB_HOST: user-db
      DB_NAME: user_db
      DB_USER: app_user
      DB_PASS: StrongP@ssw0rd!
      JWT_SECRET: supersecretkey
    depends_on:
      user-db:
        condition: service_healthy

  user-db:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "StrongP@ssw0rd!"
      MSSQL_PID: "Express"
    ports:
      - "1437:1433"
    healthcheck:
      test: ["CMD", "/opt/mssql-tools/bin/sqlcmd", "-S", "user-db", "-U", "app_user", "-P", "StrongP@ssw0rd!", "-Q", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  catalog-service:
    build:
      context: .
      dockerfile: ./catalog-service/Dockerfile
    dns:
      - 8.8.8.8
      - 8.8.4.4
    ports:
      - "3001:3001"
    environment:
      DB_HOST: catalog-db
      DB_NAME: catalog_db
      DB_USER: app_user
      DB_PASS: StrongP@ssw0rd!
    depends_on:
      catalog-db:
        condition: service_healthy

  catalog-db:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "StrongP@ssw0rd!"
      MSSQL_PID: "Express"
    ports:
      - "1433:1433"
    healthcheck:
      test: ["CMD", "/opt/mssql-tools/bin/sqlcmd", "-S", "catalog-db", "-U", "app_user", "-P", "StrongP@ssw0rd!", "-Q", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  seating-service:
    build:
      context: .
      dockerfile: ./seating-service/Dockerfile
    dns:
      - 8.8.8.8
      - 8.8.4.4
    ports:
      - "3002:3002"
    environment:
      DB_HOST: seating-db
      DB_NAME: seating_db
      DB_USER: app_user
      DB_PASS: StrongP@ssw0rd!
    depends_on:
      seating-db:
        condition: service_healthy

  seating-db:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "StrongP@ssw0rd!"
      MSSQL_PID: "Express"
    ports:
      - "1434:1433"
    healthcheck:
      test: ["CMD", "/opt/mssql-tools/bin/sqlcmd", "-S", "seating-db", "-U", "app_user", "-P", "StrongP@ssw0rd!", "-Q", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  order-service:
    build:
      context: .
      dockerfile: ./order-service/Dockerfile
    dns:
      - 8.8.8.8
      - 8.8.4.4
    ports:
      - "3003:3003"
    environment:
      DB_HOST: order-db
      DB_NAME: order_db
      DB_USER: app_user
      DB_PASS: StrongP@ssw0rd!
    depends_on:
      order-db:
        condition: service_healthy
      seating-service:
        condition: service_started

  order-db:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "StrongP@ssw0rd!"
      MSSQL_PID: "Express"
    ports:
      - "1435:1433"
    healthcheck:
      test: ["CMD", "/opt/mssql-tools/bin/sqlcmd", "-S", "order-db", "-U", "app_user", "-P", "StrongP@ssw0rd!", "-Q", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  payment-service:
    build:
      context: .
      dockerfile: ./payment-service/Dockerfile
    dns:
      - 8.8.8.8
      - 8.8.4.4
    ports:
      - "3004:3004"
    environment:
      DB_HOST: payment-db
      DB_NAME: payment_db
      DB_USER: app_user
      DB_PASS: StrongP@ssw0rd!
    depends_on:
      payment-db:
        condition: service_healthy

  payment-db:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "StrongP@ssw0rd!"
      MSSQL_PID: "Express"
    ports:
      - "1436:1433"
    healthcheck:
      test: ["CMD", "/opt/mssql-tools/bin/sqlcmd", "-S", "payment-db", "-U", "app_user", "-P", "StrongP@ssw0rd!", "-Q", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  notification-service:
    build:
      context: .
      dockerfile: ./notification-service/Dockerfile
    dns:
      - 8.8.8.8
      - 8.8.4.4
    ports:
      - "3005:3005"
    environment:
      SMTP_HOST: smtp.example.com
      SMTP_PORT: 587
      SMTP_USER: your-email@example.com
      SMTP_PASS: your-email-password

  # Seed service: runs the seedDataToDB.js script after DBs are healthy
  db-seed:
    image: node:18
    working_dir: /app
    volumes:
      - ./:/app:ro
    command: ["node", "seedDataToDB.js"]
    environment:
      SEED_DB_USER: app_user
      SEED_DB_PASS: StrongP@ssw0rd!
      SEED_DB_PORT: 1433
      SEED_DB_DIALECT: mssql
    depends_on:
      catalog-db:
        condition: service_healthy
      order-db:
        condition: service_healthy
      payment-db:
        condition: service_healthy
      seating-db:
        condition: service_healthy
      user-db:
        condition: service_healthy