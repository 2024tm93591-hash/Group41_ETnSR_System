services:
  mongo:
    image: mongo:6.0
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db

  auth-service:
    build:
      context: ./auth_service
      dockerfile: Dockerfile
    ports:
      - "5000:5000"
    volumes:
      - auth-service-data:/app/instance
    environment:
      FLASK_APP: app.py
      FLASK_ENV: production
      MONGO_URI: "mongodb://root:example@mongo:27017/auth_db?authSource=admin"
    restart: always

  user-service:
    build:
      context: .
      dockerfile: ./user-service/Dockerfile
    dns:
      - 8.8.8.8
      - 8.8.4.4
    ports:
      - "3000:3000"
    environment:
      DB_HOST: user-db
      DB_NAME: user_db
      DB_USER: app_user
      DB_PASS: StrongP@ssw0rd!
      MONGO_URI: "mongodb://root:example@mongo:27017/user_db?authSource=admin"
      JWT_SECRET: supersecretkey
    depends_on:
      user-db:
        condition: service_healthy

  user-db:
    build:
      context: .
      dockerfile: db.Dockerfile
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "StrongP@ssw0rd!"
      MSSQL_PID: "Express"
    ports:
      - "1437:1433"
    volumes:
      - user-db-data:/var/opt/mssql
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -b -V 16 -S localhost -U sa -P "StrongP@ssw0rd!" -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 30s
    restart: always

  catalog-service:
    build:
      context: ./catalog-service/catalog-service
      dockerfile: Dockerfile
    dns:
      - 8.8.8.8
      - 8.8.4.4
    ports:
      - "3001:3001"
    environment:
      SPRING_DATA_MONGODB_URI: "mongodb://root:example@mongo:27017/catalogdb?authSource=admin"
    depends_on:
      - mongo

  catalog-db:
    build:
      context: .
      dockerfile: db.Dockerfile
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "StrongP@ssw0rd!"
      MSSQL_PID: "Express"
    ports:
      - "1433:1433"
    volumes:
      - catalog-db-data:/var/opt/mssql
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -b -V 16 -S localhost -U sa -P "StrongP@ssw0rd!" -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 30s
    restart: always

  seating-service:
    build:
      context: .
      dockerfile: ./seating-service/Dockerfile
    dns:
      - 8.8.8.8
      - 8.8.4.4
    ports:
      - "3002:3002"
    environment:
      DB_HOST: seating-db
      DB_NAME: seating_db
      DB_USER: app_user
      DB_PASS: StrongP@ssw0rd!
      MONGO_URI: "mongodb://root:example@mongo:27017/seating_db?authSource=admin"
    depends_on:
      seating-db:
        condition: service_healthy

  seating-db:
    build:
      context: .
      dockerfile: db.Dockerfile
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "StrongP@ssw0rd!"
      MSSQL_PID: "Express"
    ports:
      - "1434:1433"
    volumes:
      - seating-db-data:/var/opt/mssql
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -b -V 16 -S localhost -U sa -P "StrongP@ssw0rd!" -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 30s
    restart: always

  order-service:
    build:
      context: ./order-service
      dockerfile: Dockerfile
    dns:
      - 8.8.8.8
      - 8.8.4.4
    ports:
      - "8081:8081"
    environment:
      SPRING_DATA_MONGODB_URI: "mongodb://root:example@mongo:27017/ordersdb?authSource=admin"
      PAYMENT_SERVICE_URL: "http://payment-service:8082"
    depends_on:
      - mongo
      - payment-service

  order-db:
    build:
      context: .
      dockerfile: db.Dockerfile
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "StrongP@ssw0rd!"
      MSSQL_PID: "Express"
    ports:
      - "1435:1433"
    volumes:
      - order-db-data:/var/opt/mssql
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -b -V 16 -S localhost -U sa -P "StrongP@ssw0rd!" -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 30s
    restart: always

  payment-service:
    build:
      context: ./payment-service
      dockerfile: Dockerfile
    dns:
      - 8.8.8.8
      - 8.8.4.4
    ports:
      - "8082:8082"
    environment:
      SPRING_DATA_MONGODB_URI: "mongodb://root:example@mongo:27017/paymentsdb?authSource=admin"
    depends_on:
      - mongo

  payment-db:
    build:
      context: .
      dockerfile: db.Dockerfile
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "StrongP@ssw0rd!"
      MSSQL_PID: "Express"
    ports:
      - "1436:1433"
    volumes:
      - payment-db-data:/var/opt/mssql
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -b -V 16 -S localhost -U sa -P "StrongP@ssw0rd!" -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 30s
    restart: always

  notification-service:
    build:
      context: .
      dockerfile: ./notification-service/Dockerfile
    dns:
      - 8.8.8.8
      - 8.8.4.4
    ports:
      - "3005:3005"
    environment:
      SMTP_HOST: smtp.example.com
      SMTP_PORT: 587
      SMTP_USER: your-email@example.com
      SMTP_PASS: your-email-password
      MONGO_URI: "mongodb://root:example@mongo:27017/notification_db?authSource=admin"

  # Seed service: runs the seedDataToDB.js script after DBs are healthy
  db-seed:
    image: node:18
    working_dir: /app
    volumes:
      - ./:/app:ro
    command: ["node", "seedDataToDB.js"]
    environment:
      SEED_DB_USER: app_user
      SEED_DB_PASS: StrongP@ssw0rd!
      SEED_DB_PORT: 1433
      SEED_DB_DIALECT: mssql
      SEED_MONGO_URI: "mongodb://root:example@mongo:27017/seed_db?authSource=admin"
    depends_on:
      catalog-db:
        condition: service_healthy
      order-db:
        condition: service_healthy
      payment-db:
        condition: service_healthy
      seating-db:
        condition: service_healthy
      user-db:
        condition: service_healthy

volumes:
  auth-service-data:
  mongo-data:
  user-db-data:
  catalog-db-data:
  seating-db-data:
  order-db-data:
  payment-db-data: